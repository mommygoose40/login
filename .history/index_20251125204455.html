<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>登入中...</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: Arial; text-align: center; padding-top: 60px; }
</style>
</head>

<body>
<h2>登入中，請稍候...</h2>

<script>
const LIFF_ID = "2007934728-q468EB12";  
const GAS_URL = "https://script.google.com/macros/s/AKfycbwQ2G5azRrHL0Qw4xaVwbh8yDqKGLWPPwsZixqcmDSg6wsnl95-tlbG24oX8jLjo1Ga/exec?action=checkRegistered";

async function main() {

  liff.init({ liffId: LIFF_ID })
    .then(async () => {

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      // 取得使用者資料
      const profile = await liff.getProfile();
      const lineName = profile.displayName;
      const lineUserId = profile.userId;

      // 儲存到 localStorage
      localStorage.setItem("lineName", lineName);
      localStorage.setItem("lineUserId", lineUserId);

      // 呼叫 GAS 檢查是否已開通
      const url = `${GAS_URL}&lineUserId=${encodeURIComponent(lineUserId)}&nickname=${encodeURIComponent(lineName)}`;
      const res = await fetch(url);
      const data = await res.json();

      if (data.registered) {
        // 已開通 → 進主畫面
        window.location.href = "https://home-blush-six.vercel.app/";
      } else {
        // 未開通 → 顯示提示
        document.body.innerHTML = `
          <h2>尚未開通使用權限</h2>
          <p>請通知管理員協助開通帳號</p>
        `;
      }
    })
    .catch(err => {
      document.body.innerHTML = `
        <h2 style="color:red;">LIFF 初始化錯誤</h2>
        <p>${err.message}</p>
      `;
    });
}

main();
</script>

</body>
</html>
