<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>防汛通報系統</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f5f8ff;
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* 遮罩 */
  #loadingMask {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    font-size: 26px;
    color: white;
  }

  .spinner {
    width: 42px;
    height: 42px;
    border: 4px solid #eee;
    border-top: 4px solid #0b5ed7;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 14px;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }
</style>
</head>

<body>

<!-- 遮罩 + 加載動畫 -->
<div id="loadingMask">
  <div class="spinner"></div>
  <div id="loadingText">自動登入中...</div>
</div>

<script>
/* ===== 配置 ===== */
const LIFF_ID = "2007934728-q468EB12";
const GAS_URL = "https://script.google.com/macros/s/AKfycbwQ2G5azRrHL0Qw4xaVwbh8yDqKGLWPPwsZixqcmDSg6wsnl95-tlbG24oX8jLjo1Ga/exec";

async function main(){
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  const lineName = profile.displayName;
  const lineUserId = profile.userId;

  localStorage.setItem("lineName", lineName);
  localStorage.setItem("lineUserId", lineUserId);

  // 正確帶參數（第一個一定要 ?）
  const url =
    `${GAS_URL}?action=checkRegistered&lineUserId=${encodeURIComponent(lineUserId)}&nickname=${encodeURIComponent(lineName)}`;

  const resp = await fetch(url);
  const data = await resp.json();

  console.log("GAS 回應：", data);

  if (!data.registered) {
    localStorage.setItem("unregistered", "1");
  }

  window.location.href =
  `https://home-blush-six.vercel.app/?unreg=${!data.registered ? "1" : "0"}`;
}

main();

/* ===== 隱藏遮罩 ===== */
function hideLoading() {
  document.getElementById("loadingMask").style.display = "none";
}

/* ===== 自訂提示窗（引用你的註冊頁邏輯） ===== */
function showWarningAlert(title, message = '') {
  createCustomAlert(title, message, false);
}

function createCustomAlert(title, message = '', isSuccess = false) {

  document.getElementById('customAlert')?.remove();
  document.body.style.overflow = 'hidden';

  const overlay = document.createElement('div');
  overlay.id = 'customAlert';
  Object.assign(overlay.style, {
    position: 'fixed',
    inset: '0',
    background: 'rgba(0,0,0,0.6)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: '10000'
  });

  const hasMessage = message.trim().length > 0;

  const iconHTML = isSuccess
    ? `<span style="font-size:26px;">✔️</span>`
    : `<span style="font-size:32px;">⚠️</span>`;

  const styleConfig = hasMessage
    ? { padding: '34px 48px 36px', fontSize: '20px', maxWidth: '78%', lineHeight: '1.8' }
    : { padding: '30px 40px', fontSize: '22px', maxWidth: '80%', lineHeight: '1.5' };

  const box = document.createElement('div');
  Object.assign(box.style, {
    background: '#fff',
    color: '#000',
    borderRadius: '12px',
    textAlign: 'center',
    boxShadow: '0 4px 20px rgba(0,0,0,0.3)',
    ...styleConfig
  });

  box.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      ${iconHTML}
      <span style="font-weight:bold;font-size:24px;">${title}</span>
    </div>
    ${hasMessage ? `<div style="font-size:21px;color:#333;margin-top:10px;">${message}</div>` : ''}
  `;

  const btn = document.createElement('button');
  btn.textContent = '確定';
  Object.assign(btn.style, {
    marginTop: '24px',
    fontSize: '20px',
    padding: '10px 28px',
    borderRadius: '8px',
    border: 'none',
    background: '#0b5ed7',
    color: '#fff',
    cursor: 'pointer'
  });

  btn.onclick = () => {
    overlay.remove();
    document.body.style.overflow = '';
  };

  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}
</script>

</body>
</html>
